{% extends 'base.html' %} {% block title %}Build Log - AppCenter{% endblock %}
{% block content %}
<div class="container">
  <!-- Back button and build information -->
  <div class="d-flex align-items-center mb-4">
    <a
      href="{{ url_for('build.github_build') }}"
      class="btn btn-sm btn-outline-secondary me-3"
    >
      <i class="fas fa-arrow-left me-1"></i> Back to Builds
    </a>
    <h1 class="fw-bold mb-0">Build Log</h1>

    <div class="ms-auto">
      {% if build.status == 'completed' %}
      <a
        href="{{ url_for('build.download_build', build_id=build.id) }}"
        class="btn btn-success me-2"
      >
        <i class="fas fa-download me-2"></i>Download IPA
      </a>
      {% endif %} {% if build.status == 'building' or build.status ==
      'in_progress' or build.status == 'queued' %}
      <a
        href="{{ url_for('build.stop_build', build_id=build.id) }}"
        class="btn btn-danger me-2"
        onclick="return confirm('Are you sure you want to stop this build?');"
      >
        <i class="fas fa-stop-circle me-1"></i>Stop Build
      </a>
      {% endif %}

      <!-- Add manual fork cleanup button -->
      {% if 'fork_info' in build and (build.status == 'failed' or build.status
      == 'completed' or build.status == 'cancelled') %}
      <form
        action="{{ url_for('cleanup_repository', build_id=build.id) }}"
        method="POST"
        class="d-inline"
      >
        <button
          type="submit"
          class="btn btn-warning me-2"
          onclick="return confirm('Are you sure you want to manually clean up the forked repository? This is only needed if automatic cleanup failed.');"
        >
          <i class="fas fa-trash-alt me-1"></i>Clean Up Fork
        </button>
      </form>
      {% endif %}

      <a
        href="{{ url_for('build.download_build_log', build_id=build.id) }}"
        class="btn btn-outline-secondary"
      >
        <i class="fas fa-file-download me-1"></i>Download Log
      </a>
    </div>
  </div>

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fab fa-github me-2"></i>
          {% if build.app_name %}{{ build.app_name }}{% else %}GitHub Build{%
          endif %}
        </h5>

        <div>
          {% if build.status == 'completed' %}
          <span class="status-badge status-completed">
            <i class="fas fa-check-circle"></i> Completed
          </span>
          {% elif build.status == 'queued' %}
          <span class="status-badge status-queued">
            <i class="fas fa-clock"></i> Queued
          </span>
          {% elif build.status == 'building' or build.status == 'in_progress' %}
          <span class="status-badge status-building pulse-animation">
            <i class="fas fa-spinner fa-spin"></i> Building
          </span>
          {% elif build.status == 'cancelled' %}
          <span class="status-badge status-cancelled">
            <i class="fas fa-ban"></i> Cancelled
          </span>
          {% else %}
          <span class="status-badge status-failed">
            <i class="fas fa-times-circle"></i> Failed
          </span>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="card-body p-0">
      <!-- Repository and branch information card at the top -->
      <div class="p-4 bg-dark border-bottom">
        <h5 class="mb-3 text-white">
          <i class="fas fa-info-circle me-2"></i>Build Information
        </h5>

        <div class="row">
          <div class="col-md-6">
            <div
              class="card border-0 shadow-sm mb-3"
              style="background-color: rgba(255, 255, 255, 0.05)"
            >
              <div class="card-body p-3">
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    <i class="fab fa-github fa-2x text-primary"></i>
                  </div>
                  <div>
                    <h6 class="fw-bold mb-1">Repository</h6>
                    <div class="text-primary small">
                      {% if build.repo_url %} {% if 'github.com' in
                      build.repo_url %} {% if not
                      build.repo_url.startswith('http') %}
                      <a
                        href="https://{{ build.repo_url }}"
                        target="_blank"
                        class="text-decoration-none"
                      >
                        {{ build.repo_url }}
                        <i class="fas fa-external-link-alt ms-1 small"></i>
                      </a>
                      {% else %}
                      <a
                        href="{{ build.repo_url }}"
                        target="_blank"
                        class="text-decoration-none"
                      >
                        {{ build.repo_url }}
                        <i class="fas fa-external-link-alt ms-1 small"></i>
                      </a>
                      {% endif %} {% else %}
                      <a
                        href="https://github.com/{{ build.repo_url }}"
                        target="_blank"
                        class="text-decoration-none"
                      >
                        {{ build.repo_url }}
                        <i class="fas fa-external-link-alt ms-1 small"></i>
                      </a>
                      {% endif %} {% else %}
                      <span class="text-muted">Not specified</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div
              class="card border-0 shadow-sm mb-3"
              style="background-color: rgba(255, 255, 255, 0.05)"
            >
              <div class="card-body p-3">
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    <i class="fas fa-code-branch fa-2x text-info"></i>
                  </div>
                  <div>
                    <h6 class="fw-bold mb-1">Branch</h6>
                    <div class="small">
                      {% if build.branch %}
                      <span class="badge bg-info text-dark">
                        {{ build.branch }}
                      </span>
                      {% else %}
                      <span class="text-muted">Not specified</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="p-3 bg-dark border-bottom">
        <div class="row g-2 text-muted small">
          <div class="col-md-3">
            <div><strong>App Name:</strong></div>
            <div class="text-white">
              {{ build.app_name if build.app_name else 'N/A' }}
            </div>
          </div>
          <div class="col-md-2">
            <div><strong>Started:</strong></div>
            <div>
              {{ build.start_time|format_date if build.start_time else 'N/A' }}
            </div>
          </div>
          <div class="col-md-3">
            <div><strong>Duration:</strong></div>
            <div class="text-white">
              {% if build.duration %}
              <span class="badge bg-info">{{ build.duration }}</span>
              {% elif build.status == 'building' or build.status ==
              'in_progress' or build.status == 'queued' %}
              <span class="badge bg-warning text-dark">Running...</span>
              {% else %}
              <span class="text-muted">N/A</span>
              {% endif %}
            </div>
          </div>
          <div class="col-md-4">
            <div><strong>Configuration:</strong></div>
            <div>
              {{ build.build_config }} - Xcode {{
              build.xcode_version|default('Latest', true) }}
            </div>
          </div>
        </div>
      </div>

      <pre
        class="build-log mb-0 px-4 py-3"
        style="max-height: 600px; overflow-y: auto"
      >
{{ build.log_content }}</pre
      >
    </div>

    {% if build.status == 'building' or build.status == 'in_progress' or
    build.status == 'queued' %}
    <div class="card-footer bg-dark text-center py-3">
      <div
        class="spinner-border spinner-border-sm text-primary me-2"
        role="status"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
      <span>Build in progress - this page will refresh automatically</span>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %} {% block scripts %} {% if build.status == 'building' or
build.status == 'in_progress' or build.status == 'queued' %}
<script>
  // Auto-refresh the page every 5 seconds if the build is in progress
  setTimeout(function () {
    window.location.reload();
  }, 5000);
</script>
{% endif %} {% endblock %}
