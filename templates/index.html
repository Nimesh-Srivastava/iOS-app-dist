{% extends 'base.html' %} {% block title %}IPA Distribution Server{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Available Apps</h1>
  {% if g.user and g.user.role == 'admin' %}
  <a href="{{ url_for('upload') }}" class="btn btn-primary">Upload New App</a>
  {% endif %}
</div>

<!-- Add data attributes for auto-refresh functionality -->
<div
  id="app-data"
  data-app-count="{{ app_count }}"
  data-timestamp="{{ latest_timestamp|default('', true) }}"
  style="display: none"
></div>

{% if apps %}
<div class="row row-cols-1 row-cols-md-3 g-4">
  {% for app in apps %}
  <div class="col">
    <div class="card app-card h-100">
      <div class="card-body">
        <span class="version-badge badge bg-primary">v{{ app.version }}</span>
        <div class="text-center mb-3">
          <img
            src="{{ app.icon }}"
            alt="{{ app.name }}"
            class="img-thumbnail mb-2"
            style="width: 80px; height: 80px"
          />
          <h5 class="card-title">{{ app.name }}</h5>
        </div>
        <p class="card-text">
          <small class="text-muted"
            >Last updated: {% if app.upload_date %} {{
            app.upload_date.split('T')[0] }} {% elif app.creation_date %} {{
            app.creation_date.split('T')[0] }} {% else %} Unknown {% endif %} </small
          ><br />
          <small class="text-muted"
            >Size: {% if app.size %} {{ (app.size / 1024 / 1024) | round(2) }}
            MB {% else %} Unknown {% endif %}
          </small>
        </p>
      </div>
      <div
        class="card-footer bg-transparent border-top-0 d-flex justify-content-between"
      >
        <a
          href="{{ url_for('app_detail', app_id=app.id) }}"
          class="btn btn-sm btn-outline-primary"
          >Details</a
        >
        <a
          href="{{ url_for('install', app_id=app.id) }}"
          class="btn btn-sm btn-success"
          >Install</a
        >
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="alert alert-info">
  <p>No apps have been uploaded yet.</p>
  {% if g.user and g.user.role == 'admin' %}
  <p>
    <a href="{{ url_for('upload') }}" class="alert-link"
      >Upload your first app</a
    >
    to get started.
  </p>
  {% endif %}
</div>
{% endif %} {% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Get app data from data attributes
    var appData = document.getElementById("app-data");
    var lastAppCount = parseInt(appData.getAttribute("data-app-count"), 10);
    var lastTimestamp = appData.getAttribute("data-timestamp");

    // Auto-refresh functionality
    function checkForUpdates() {
      fetch("/api/app_status")
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          if (
            data.count !== lastAppCount ||
            (data.latest_timestamp && data.latest_timestamp !== lastTimestamp)
          ) {
            console.log("New apps detected! Refreshing page...");
            window.location.reload();
          }
        })
        .catch(function (error) {
          console.error("Error checking for updates:", error);
        });
    }

    // Check for updates every 5 seconds
    setInterval(checkForUpdates, 5000);
  });
</script>
{% endblock %}
