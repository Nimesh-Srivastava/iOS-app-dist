{% extends 'base.html' %} {% block title %}Build from GitHub{% endblock %} {%
block content %}
<div class="container mt-4">
  <h2>Build iOS App from GitHub Repository</h2>

  {% with messages = get_flashed_messages() %} {% if messages %} {% for message
  in messages %}
  <div class="alert alert-info">{{ message }}</div>
  {% endfor %} {% endif %} {% endwith %}

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">New Build</h5>
    </div>
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="repo_url" class="form-label">GitHub Repository URL</label>
          <input
            type="text"
            class="form-control"
            id="repo_url"
            name="repo_url"
            placeholder="https://github.com/username/repository"
            required
          />
          <div class="form-text">
            Enter the full URL to the GitHub repository
          </div>
        </div>

        <div class="mb-3">
          <label for="branch" class="form-label">Branch/Tag</label>
          <input
            type="text"
            class="form-control"
            id="branch"
            name="branch"
            placeholder="main"
            value="main"
          />
          <div class="form-text">Branch, tag, or commit hash to build from</div>
        </div>

        <div class="mb-3">
          <label for="app_name" class="form-label">App Name</label>
          <input
            type="text"
            class="form-control"
            id="app_name"
            name="app_name"
            placeholder="My iOS App"
            required
          />
        </div>

        <div class="mb-3">
          <label for="certificate" class="form-label"
            >iOS Certificate File (.p12)</label
          >
          <input
            type="file"
            class="form-control"
            id="certificate"
            name="certificate"
          />
          <div class="form-text">Optional: Upload your signing certificate</div>
        </div>

        <div class="mb-3">
          <label for="provisioning_profile" class="form-label"
            >Provisioning Profile (.mobileprovision)</label
          >
          <input
            type="file"
            class="form-control"
            id="provisioning_profile"
            name="provisioning_profile"
          />
          <div class="form-text">
            Optional: Upload your provisioning profile
          </div>
        </div>

        <div class="mb-3">
          <label for="team_id" class="form-label">Apple Team ID</label>
          <input
            type="text"
            class="form-control"
            id="team_id"
            name="team_id"
            placeholder="XXXXXXXXXX"
          />
          <div class="form-text">
            Your Apple Developer Team ID (10-character identifier)
          </div>
        </div>

        <div class="mb-3">
          <label for="build_config" class="form-label"
            >Build Configuration</label
          >
          <select class="form-select" id="build_config" name="build_config">
            <option value="Debug">Debug</option>
            <option value="Release" selected>Release</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="xcode_version" class="form-label">Xcode Version</label>
          <select class="form-select" id="xcode_version" name="xcode_version">
            <option value="latest" selected>Latest Available</option>
            <option value="15.3">Xcode 15.3</option>
            <option value="15.2">Xcode 15.2</option>
            <option value="15.1">Xcode 15.1</option>
            <option value="15.0">Xcode 15.0</option>
            <option value="14.3">Xcode 14.3</option>
            <option value="14.2">Xcode 14.2</option>
            <option value="14.1">Xcode 14.1</option>
            <option value="14.0">Xcode 14.0</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary">Start Build</button>
      </form>
    </div>
  </div>

  <!-- GitHub Actions Card -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="fas fa-sync-alt"></i> GitHub Actions Integration
      </h5>
    </div>
    <div class="card-body">
      <p>
        <strong>NEW!</strong> You can now use GitHub Actions to automate your
        iOS app builds directly in your repository.
      </p>

      <h6 class="mt-3">Benefits:</h6>
      <ul>
        <li>Automated builds on every push or pull request</li>
        <li>Build with specific Xcode versions</li>
        <li>Run tests on iOS simulators</li>
        <li>Customize build parameters</li>
        <li>Artifacts uploaded automatically to this distribution system</li>
      </ul>

      <h6 class="mt-3">How to set up:</h6>
      <ol>
        <li>
          Add the workflow file to your repository at
          <code>.github/workflows/build-ios-app.yml</code>
        </li>
        <li>
          Configure the required secrets in your GitHub repository settings
        </li>
        <li>Push to your repository or manually trigger the workflow</li>
      </ol>

      <div class="mt-3">
        <a
          href="{{ github_repo_url }}/blob/main/.github/workflows/build-ios-app.yml"
          target="_blank"
          class="btn btn-outline-primary"
        >
          <i class="fab fa-github"></i> View Example Workflow
        </a>
        <a
          href="{{ github_repo_url }}#github-actions-integration"
          target="_blank"
          class="btn btn-outline-secondary"
        >
          <i class="fas fa-book"></i> Read Documentation
        </a>
      </div>
    </div>
  </div>

  {% if builds %}
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Recent Builds</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Repository</th>
              <th>Branch</th>
              <th>Status</th>
              <th>Started</th>
              <th>Completed</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for build in builds %}
            <tr>
              <td>{{ build.repo_url }}</td>
              <td>{{ build.branch }}</td>
              <td>
                {% if build.status == 'completed' %}
                <span class="badge bg-success">Completed</span>
                {% elif build.status == 'failed' %}
                <span class="badge bg-danger">Failed</span>
                {% elif build.status == 'in_progress' %}
                <span class="badge bg-warning text-dark">In Progress</span>
                {% else %}
                <span class="badge bg-secondary">Queued</span>
                {% endif %}
              </td>
              <td>{{ build.start_time }}</td>
              <td>{{ build.end_time if build.end_time else 'N/A' }}</td>
              <td>
                {% if build.status == 'completed' %}
                <a
                  href="{{ url_for('download_build', build_id=build.id) }}"
                  class="btn btn-sm btn-primary"
                  >Download</a
                >
                {% endif %} {% if build.log %}
                <a
                  href="{{ url_for('build_log', build_id=build.id) }}"
                  class="btn btn-sm btn-info"
                  >View Log</a
                >
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
